# Contributing

## Setting Up A Development Environment

You can quickly set up a [Vagrant](https://www.vagrantup.com/)-based development environment by
cloning the [otm-vagrant](https://github.com/opentreemap/otm2-vagrant)
repository.

## Django and Python style

### Indentation

Four spaces. No tabs, please.

### Linting

We run all of our Python code (excluding migrations and settings)
through [flake8](https://flake8.readthedocs.org/en/2.2.3/). If you are
using the vagrant-based development setup, you can use this command to
run flake8:

```
vagrant ssh -c 'cd /vagrant/otm-core/opentreemap; flake8 --exclude migrations,opentreemap/settings/local_settings.py *'
```

To avoid build failures make sure to run this command against
your changes before opening a pull request.

### Testing

We try to unit test as much of our code as possible.
If you are using the vagrant-based development setup, this command
will run the test suite:

```
vagrant ssh -c 'cd /vagrant/otm-core/opentreemap && ./manage.py test --noinput'
```

To avoid build failures please run the unit tests before submitting a
pull request if you modify Python code.


### View Functions

OpenTreeMap uses functional views rather than class-based views and
prefers nested calls rather than decorators, to simplify testing and
composability. Read through [decorators.py](https://github.com/OpenTreeMap/otm-core/blob/master/opentreemap/treemap/decorators.py)
file, and also the [django-tinsel project](https://github.com/azavea/django-tinsel) and it's `decorate` and `route` functions, which we use as the foundation of our composed view
functions. For a good example of how these functions are used,
reference [the treemap views module](https://github.com/OpenTreeMap/otm-core/blob/master/opentreemap/treemap/views/__init__.py)

### Templates

Nearly all of the markup for OpenTreeMap is generated by Django
templates, rather than client-side Javascript. If you are going to
create markup, we prefer that it is created via a Django template.

## Javascript Style and Patterns

### Indentation

Four spaces. No tabs, please.

### Modules

We use [browserify](http://browserify.org/) to compile nodejs-style
modules for use in the browser. If you are using the vagrant-based
development environment running this command will compile a Javascript
bundle and collect all the static Django assets

```
vagrant ssh -c 'cd /vagrant/otm-core/; ./node_modules/.bin/grunt --dev'
```

### Bacon.js

We use [Bacon.js](http://baconjs.github.io/) to manage events in the
browser. Please reference the existing modules in the
[src](https://github.com/OpenTreeMap/otm-core/tree/master/opentreemap/treemap/js/src)
directory for examples of how we use stream processing rather than
directly attaching callbacks to DOM events.

### Linting

We run all of our Javascript code through
[jshint](http://jshint.com/). If you are using the vagrant-based
development setup, you can use this command to run jshint:

```
vagrant ssh -c 'cd /vagrant/otm-core && npm run check'
```

To avoid build failures make sure to run this command against
your changes before opening a pull request if you have added or
modified any Javascript code.

### Testing

We have built a [mocha](http://visionmedia.github.io/mocha/)-based
unit test setup for our Javascript. The
[html test harness](https://github.com/OpenTreeMap/otm-core/blob/master/opentreemap/treemap/js/test/test.html)
handles finding and executing tests from any of the modules in the
[test directory](https://github.com/OpenTreeMap/otm-core/tree/master/opentreemap/treemap/js/test).
Individual tests are just functions exported from a module in the test
directory. You can open ``test.html`` to run the tests on demand, or
use [testem](https://github.com/airportyh/testem) to run the test
suite when files change.

## Architecture

This section addresses the question of where code should live.

### Permissions

Because of the complicated relationship of models associated with permission checking, permissions are centralized in a module, `treemap/lib/perms.py`, instead of added as methods to a class. Functions that check permissions should be written to accept a number of related types or type combinations and stored in this module. The private functions in this module should be responsible for walking the necessary relationships in order to check the permission properly.
